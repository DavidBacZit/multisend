<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
</head>
<body>

  <!-- 1. Connect Wallet Button -->
  <button id="connectButton">Connect Wallet</button>
  <p id="walletAddress"></p>

  <!-- 2. CSV Upload (address, amount in ETH) -->
  <input type="file" id="csvFileInput" accept=".csv" />
  <p id="fileStatus"></p>

  <!-- 3. Send Multisend Transaction -->
  <button id="sendButton" disabled>Send Multisend</button>

  <pre id="output"></pre>

  <script>
    // ====== Configuration ======
    const MULTISEND_CONTRACT_ADDRESS = "0x6C2C960A7dFe6196Dfb08e71F5973bd4f6B8129f";

    // ====== Globals ======
    let userAddress = null;
    let parsedRows = []; // Array of { to: "0x...", amountWei: BigInt(...) }
    let totalValueWei = BigInt(0);

    // 1 ETH = 10^18 wei
    const WEI_PER_ETH = BigInt("1000000000000000000");

    // ====== Helper: parse decimal ETH string into BigInt wei ======
    function parseEther(amountStr) {
      amountStr = amountStr.trim();
      if (amountStr === "") {
        throw new Error("Empty amount");
      }
      // Must match /^\d+(\.\d{1,18})?$/
      if (!/^\d+(\.\d{1,18})?$/.test(amountStr)) {
        throw new Error("Invalid ETH amount: " + amountStr);
      }
      if (!amountStr.includes(".")) {
        return BigInt(amountStr) * WEI_PER_ETH;
      }
      const [whole, fraction] = amountStr.split(".");
      const paddedFraction = fraction.padEnd(18, "0").slice(0, 18);
      const wholeWei = BigInt(whole) * WEI_PER_ETH;
      const fracWei = BigInt(paddedFraction);
      return wholeWei + fracWei;
    }

    // ====== Connect Wallet ======
    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask or another Ethereum wallet is required.");
        return;
      }
      try {
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts",
        });
        userAddress = accounts[0];
        document.getElementById("walletAddress").innerText =
          "Connected: " + userAddress;
        if (parsedRows.length > 0) {
          document.getElementById("sendButton").disabled = false;
        }
      } catch (err) {
        console.error(err);
        alert("User rejected wallet connection.");
      }
    }

    document
      .getElementById("connectButton")
      .addEventListener("click", connectWallet);

    // ====== Handle CSV Upload ======
    document
      .getElementById("csvFileInput")
      .addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        try {
          parseCSV(text);
          document.getElementById("fileStatus").innerText =
            "CSV parsed: " + parsedRows.length + " rows.";
          if (userAddress && parsedRows.length > 0) {
            document.getElementById("sendButton").disabled = false;
          }
        } catch (err) {
          document.getElementById("fileStatus").innerText =
            "Error parsing CSV: " + err.message;
          parsedRows = [];
          totalValueWei = BigInt(0);
          document.getElementById("sendButton").disabled = true;
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(csvText) {
      parsedRows = [];
      totalValueWei = BigInt(0);

      const lines = csvText
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter((l) => l.length > 0);

      if (lines.length === 0) {
        throw new Error("CSV is empty.");
      }

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(",");
        if (parts.length !== 2) {
          throw new Error(
            `Line ${i + 1} is invalid. Each line must have exactly 2 values separated by a comma.`
          );
        }
        const rawAddress = parts[0].trim();
        const rawAmount = parts[1].trim();

        // Validate address: must be 0x followed by 40 hex chars
        if (!/^0x[a-fA-F0-9]{40}$/.test(rawAddress)) {
          throw new Error(`Line ${i + 1}: Invalid address "${rawAddress}".`);
        }
        const to = rawAddress.toLowerCase();

        // Parse ETH amount
        let amountWei;
        try {
          amountWei = parseEther(rawAmount);
        } catch (err) {
          throw new Error(`Line ${i + 1}: ${err.message}`);
        }
        if (amountWei <= 0) {
          throw new Error(`Line ${i + 1}: Amount must be > 0.`);
        }

        parsedRows.push({ to, amountWei });
        totalValueWei += amountWei;
      }

      if (parsedRows.length === 0) {
        throw new Error("CSV contains no valid rows.");
      }
    }

    // ====== Build Multisend Calldata ======
    function buildMultisendData() {
      // Each entry: 20-byte address + 32-byte amount
      let dataHex = "";
      for (const row of parsedRows) {
        let addrNoPrefix = row.to.slice(2);
        const paddedAddr = addrNoPrefix.toLowerCase().padStart(40, "0");
        let amtHex = row.amountWei.toString(16);
        if (amtHex.length > 64) {
          throw new Error("Amount too large for 32 bytes: " + amtHex);
        }
        amtHex = amtHex.padStart(64, "0");
        dataHex += paddedAddr + amtHex;
      }
      return "0x" + dataHex;
    }

    // ====== Send Multisend Transaction ======
    async function sendMultisend() {
      if (!window.ethereum) {
        alert("Ethereum wallet is required.");
        return;
      }
      if (!userAddress) {
        alert("Please connect your wallet first.");
        return;
      }
      if (parsedRows.length === 0) {
        alert("Please upload and parse a valid CSV first.");
        return;
      }

      // Validate total ETH in wallet >= totalValueWei
      try {
        const balanceHex = await window.ethereum.request({
          method: "eth_getBalance",
          params: [userAddress, "latest"],
        });
        const balance = BigInt(balanceHex);
        if (balance < totalValueWei) {
          alert(
            `Insufficient funds: need ${totalValueWei} wei but have ${balance} wei.`
          );
          return;
        }
      } catch (err) {
        console.error(err);
        alert("Failed to fetch wallet balance.");
        return;
      }

      let data;
      try {
        data = buildMultisendData();
      } catch (err) {
        document.getElementById("output").innerText =
          "Error building data: " + err.message;
        return;
      }

      const txParams = {
        from: userAddress,
        to: MULTISEND_CONTRACT_ADDRESS,
        value: "0x" + totalValueWei.toString(16),
        data: data,
      };

      try {
        const txHash = await window.ethereum.request({
          method: "eth_sendTransaction",
          params: [txParams],
        });
        document.getElementById(
          "output"
        ).innerText = `Transaction sent: ${txHash}`;
      } catch (err) {
        document.getElementById("output").innerText =
          "Error sending transaction: " + err.message;
      }
    }

    document
      .getElementById("sendButton")
      .addEventListener("click", sendMultisend);
  </script>
</body>
</html>
